ç¬¬20ç«  javascript API

æœ¬ç« å†…å®¹
Â·Atomicsä¸SharedArrayBuffer
Â·è·¨ä¸Šä¸‹æ–‡æ¶ˆæ¯
Â·Encoding API
Â·File APIä¸Blob API
Â·æ‹–æ”¾
Â·Notifications API
Â·Page Visibility API
Â·Streams API
Â·è®¡æ—¶API
Â·Webç»„ä»¶
Â·Web Cryptography API

20.1 Atomics ä¸ SharedArrayBuffer

Atomics APIé€šè¿‡å¼ºåˆ¶åŒä¸€æ—¶åˆ»åªèƒ½å¯¹ç¼“å†²åŒºæ‰§è¡Œä¸€ä¸ªæ“ä½œï¼Œå¯ä»¥è®©å¤šä¸ªä¸Šä¸‹æ–‡å®‰å…¨åœ°è¯»å†™ä¸€ä¸ªSharedArrayBuffer.

SharedArrayBuffer ä¸ SharedArrayBufferå…·æœ‰åŒæ ·çš„APIã€‚ä¸¤è€…çš„ä¸»è¦åŒºåˆ«æ˜¯ArrayBufferå¿…é¡»åœ¨ä¸åŒ
æ‰§è¡Œä¸Šä¸‹æ–‡é—´åˆ‡æ¢ï¼ŒsharedArrayBufferåˆ™å¯ä»¥è¢«ä»»æ„å¤šä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡åŒæ—¶ä½¿ç”¨ã€‚


20.2 è·¨ä¸Šä¸‹æ–‡æ¶ˆæ¯   XDMï¼ˆcross-document messagingï¼‰

æ˜¯ä¸€ç§åœ¨ä¸åŒæ‰§è¡Œä¸Šä¸‹æ–‡é—´ä¼ é€’æ¶ˆæ¯çš„èƒ½åŠ›ã€‚å¦‚www.wrox.comä¸Šçš„é¡µé¢æƒ³è¦ä¸åŒ…å«åœ¨å†…åµŒçª—æ ¼ä¸­çš„p2p.wrox.com
ä¸Šä¸Šé¢çš„é¡µé¢é€šä¿¡ã€‚åœ¨XDMä¹‹å‰ï¼Œè¦ä»¥å®‰å…¨æ–¹å¼å®ç°è¿™ç§é€šä¿¡éœ€è¦å¾ˆå¤šå·¥ä½œã€‚XDMä»¥å®‰å…¨ä»¥ç”¨çš„æ–¹å¼è§„èŒƒåŒ–äº†è¿™ä¸ªåŠŸèƒ½

æ³¨æ„ï¼šè·¨ä¸Šä¸‹æ–‡å‘¢æ¶ˆæ¯ç”¨äºçª—å£ä¹‹é—´é€šä¿¡æˆ–å·¥ä½œç°åœºä¹‹é—´é€šä¿¡ã€‚æœ¬èŠ‚ä¸»è¦ä»‹ç»ä½¿ç”¨postMessage()ä¸å…¶ä»–çª—å£
é€šä¿¡ã€‚


XDMçš„æ ¸å¿ƒæ˜¯postMessage()æ–¹æ³•ã€‚å¤„ç†XDMï¼Œè¿™ä¸ªæ–¹æ³•åæ¢åœ¨HTML5ä¸­å¾ˆå¤šåœ°æ–¹ç”¨åˆ°è¿‡ï¼Œä½†ç›®çš„éƒ½ä¸€æ ·ï¼Œéƒ½æ˜¯æŠŠ
æ•°æ®ä¼ é€åˆ°å¦ä¸€ä¸ªä½ç½®ã€‚

postMessage()æ–¹æ³•æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š
1.æ¶ˆæ¯ã€
2.è¡¨ç¤ºç›®æ ‡æ¥æ”¶æºçš„å­—ç¬¦ä¸²
3.å¯é€‰çš„å¯ä¼ è¾“å¯¹è±¡çš„æ•°ç»„ï¼ˆåªä¸å·¥ä½œçº¿ç¨‹ç›¸å…³ï¼‰

let iframeWindow = document.getElementById('myframe').contentWindow;
iframeWindow.postMessage('A secret', 'http://www.wrox.com')

æœ€åä¸€è¡Œä»£ç å°è¯•å‘å†…åµŒçª—æ ¼ä¸­å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œè€Œä¸”æŒ‡å®šäº†æºå¿…é¡»æ˜¯'http://www.wrox.com'ã€‚å¦‚æœè·ŸæºåŒ¹é…ï¼Œ
é‚£ä¹ˆæ¶ˆæ¯å°†ä¼šè¾ƒå¤åˆ°å†…åµŒçª—æ ¼ï¼›å¦åˆ™ï¼ŒpostMessage()ä»€ä¹ˆä¹Ÿä¸åšã€‚è¿™ä¸ªé™åˆ¶å¯ä»¥ä¿æŠ¤ä¿¡æ¯ä¸ä¼šå› åœ°å€æ”¹å˜è€Œ
æ³„æ¼ã€‚å¦‚æœä¸æƒ³é™åˆ¶æ¥æ”¶ç›®æ ‡ï¼Œåˆ™å¯ä»¥ç»™postMessage()çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ "*"ï¼Œä½†ä¸æ¨èè¿™ä¹ˆåšã€‚

æ¥æ”¶åˆ°XDMæ¶ˆæ¯åï¼Œwindowå¯¹è±¡ä¸Šä¼šè§¦å‘messageäº‹ä»¶ï¼Œè¿™ä¸ªäº‹ä»¶æ˜¯å¼‚æ­¥è§¦å‘çš„ï¼Œå› æ­¤ä»æ¶ˆæ¯å‘é€åˆ°æ¥æ”¶åˆ°æ¶ˆæ¯
ï¼ˆæ¥æ”¶çª—å£è§¦å‘messageäº‹ä»¶ï¼‰å¯èƒ½æœ‰å»¶è¿Ÿã€‚ä¼ ç»™onmessageäº‹ä»¶å¤„ç†ç¨‹åºçš„eventå¯¹è±¡åŒ…å«ä»¥ä¸‹3æ–¹é¢é‡è¦ä¿¡æ¯ã€‚
Â·dataï¼šä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™postMessageï¼ˆï¼‰çš„å­—ç¬¦ä¸²æ•°æ®
Â·originï¼šå‘é€æ¶ˆæ¯çš„æ–‡æ¡£æºï¼Œå¦‚â€œhttp://www.wrox.comâ€
Â·source:å‘é€æ¶ˆæ¯çš„æ–‡æ¡£ä¸­windowå¯¹è±¡çš„ä»£ç†ã€‚è¿™ä¸ªä»£ç†å¯¹è±¡ä¸»è¦ç”¨äºåœ¨å‘é€ä¸Šä¸€æ¡æ¶ˆæ¯çš„çª—å£ä¸­æ‰§è¡ŒpostMesage
æ–¹æ³•ã€‚å¦‚æœè·Ÿå‘é€çª—å£æœ‰ç›¸åŒçš„æºï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡åº”è¯¥å°±æ˜¯windowå¯¹è±¡ã€‚

æ¥æ”¶æ¶ˆæ¯ä¹‹åéªŒè¯å‘é€çª—å£çš„æºæ˜¯éå¸¸é‡è¦çš„ã€‚ä¸postMessage()çš„ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥åŒ…è£…æ•°æ®ä¸ä¼šæ„ä¼ ç»™æœªçŸ¥
é¡µé¢ä»¥ç”¨ï¼Œåœ¨onmessageäº‹ä»¶å¤„ç†ç¨‹åºä¸­æ£€æŸ¥å‘é€çª—å£çš„æºå¯ä»¥åŒ…è£…æ•°æ®æ¥è‡ªçœŸç¡®çš„åœ°æ–¹

window.addEventListener('message', event => {
  if(event.origin == 'http://www.wrox.com'){
    //æ•°æ®å¤„ç†
    processMessage(event.data)

    //å‘æ¥æºçª—å£å‘é€ä¸€æ¡æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰
    event.source.postMessage('Received!', 'http://p2p.wrox.com')
  }
})

20.3 Encoding API

ä¸»è¦ç”¨äºå®ç°å­—ç¬¦ä¸²ä¸å®šå‹æ•°ç»„ä¹‹é—´çš„è½¬æ¢ã€‚è§„èŒƒæ–°å¢äº†4ä¸ªç”¨äºæ‰§è¡Œè½¬æ¢çš„å…¨å±€ç±»ï¼š
TextEncoder
TextEncoderStream
TextDecoder
TextDecoderStream

20.3.1 æ–‡æœ¬ç¼–ç 

Encoding APIæä¾›äº†ä¸¤ç§é—´å­—ç¬¦ä¸²è½¬æ¢ä¸ºå®šå‹æ•°ç»„äºŒè¿›åˆ¶æ ¼å¼çš„æ–¹æ³•ï¼šæ‰¹é‡ç¼–ç å’Œæµç¼–ç ï¼Œè½¬æ¢æ—¶ï¼Œç¼–ç å™¨
å§‹ç»ˆä½¿ç”¨UTF-8

1.æ‰¹é‡ç¼–ç 

æ‰€è°“æ‰¹é‡ï¼ŒæŒ‡çš„æ˜¯jså¼•æ“ä¼šåŒæ­¥ç¼–ç æ•´ä¸ªå­—ç¬¦ä¸²ã€‚å¯¹äºéå¸¸é•¿å¾—å­—ç¬¦ä¸²ï¼Œå¯èƒ½ä¼šèŠ±è¾ƒé•¿æ—¶é—´ã€‚
æ‰¹é‡ç¼–ç æ˜¯é€šè¿‡TextEncoderå¾—å®ä¾‹å®Œæˆçš„ï¼š

const textEncoder = new TextEncoder()

encode()ï¼Œæ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œå¹¶ä»¥Unit8Arrayæ ¼å¼è¿”å›æ¯ä¸ªå­—ç¬¦ä¸²çš„UTF-8ç¼–ç 

const textEncoder = new TextEncoder();
const decodedText = 'foo'
const encodedText = textEncoder.encode(decodedText)
console.log(encodedText)
//Uint8Array(3)Â [102, 111, 111]

æœ‰äº›å­—ç¬¦å å¤šä¸ªç´¢å¼•ï¼Œå¦‚ğŸ˜€

encodeInto()æ–¹æ³•ï¼Œæ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å’Œç›®æ ‡Unit8Arrayï¼Œè¿”å›ä¸€ä¸ªå­—å…¸ï¼ŒåŒ…å«readå’Œwrittenå±æ€§ï¼Œåˆ†åˆ«è¡¨ç¤º
æˆåŠŸä»æºå­—ç¬¦ä¸²è¯»å–äº†å¤šå°‘å­—ç¬¦å’Œå‘ç›®æ ‡æ•°ç»„å†™å…¥äº†å¤šå°‘å­—ç¬¦ã€‚

const textEncoder = new TextEncoder();
const fooArr = new Uint8Array(3)
const barArr = new Uint8Array(2)

const fooResult = textEncoder.encodeInto('foo', fooArr)
const barResult = textEncoder.encodeInto('bar', barArr)

console.log(fooResult, fooArr)  //{read: 3, written: 3} Uint8Array(3)Â [102, 111, 111]
console.log(barResult, barArr)  //{read: 2, written: 2} Uint8Array(2)Â [98, 97]

æ³¨æ„ï¼šæ–‡æœ¬ç¼–ç ä¼šå§‹ç»ˆä½¿ç”¨UTF-8æ ¼å¼ï¼Œè€Œä¸”å¿…é¡»å†™å…¥Unit8Arrayå®ä¾‹ã€‚ä½¿ç”¨å…¶ä»–ç±»å‹æ•°ç»„ä¼šå¯¼è‡´encodeInto()
æŠ›å‡ºé”™è¯¯ã€‚

2.æµç¼–ç 

TextEncoderStreamå…¶å®å°±æ˜¯TransformStreamå½¢å¼çš„TextEncoderã€‚å°†è§£ç åçš„æ–‡æœ¬æµé€šè¿‡ç®¡é“è¾“å…¥æµç¼–ç 
ä¼šå¾—åˆ°ç¼–ç åæ–‡æœ¬å—çš„æµï¼š

async function* chars(){
  const decodedText = 'foo'
  for( let char of decodedText){
    yield await new Promise(resolve => setTimeout(resolve, 1000, char))
  }
}

const decodedTextStream = new ReadableStream({
  async start(controller){
    for await (let chunk of chars()) {
      controller.enqueue(chunk);
    }
    controller.close();
  }
})

const encodedTextStream = decodedTextStream.pipeThrough(new TextEncoderStream())

const readableStreamDefaultReader = encodedTextStream.getReader();

(async function(){
  while(true){
    const { done, value } = await readableStreamDefaultReader.read();

    if(done){
      break;
    }else{
      console.log(value)
    }
  }
})();

//Uint8ArrayÂ [102]
//Uint8ArrayÂ [111]
//Uint8ArrayÂ [111]

20.3.2 æ–‡æœ¬è§£ç 
Encoding API æä¾›äº†ä¸¤ç§å°†å®šå‹æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²çš„æ–¹å¼ï¼šæ‰¹é‡è§£ç å’Œæµè§£ç 

1.æ‰¹é‡è§£ç 

æŒ‡çš„æ˜¯jså¼•æ“ä¼šåŒæ­¥è§£ç  æ•´ä¸ªå­—ç¬¦ä¸²
const textDecoder = new TextDecoder();


const textDecoder = new TextDecoder();
const encodedText = Uint8Array.of(102, 111, 111)
const decodedText = textDecoder.decode(encodedText)
console.log(decodedText)
//foo

è§£ç å™¨ä¸å…³å¿ƒä¼ å…¥çš„æ˜¯å“ªç§å®šå‹æ•°ç»„ï¼Œä»–åªä¼šä¸“å¿ƒè§£ç æ•´ä¸ªäºŒè¿›åˆ¶è¡¨ç¤ºã€‚

const textDecoder = new TextDecoder()
const encodedText = Uint32Array.of(102, 111, 111)
const decodedText = textDecoder.decode(encodedText)
console.log(decodedText)
//"f   o   o   "

ä¸TextEncoderä¸åŒï¼ŒTextDecoderå¯ä»¥å…¼å®¹å¾ˆå¤šå­—ç¬¦ç¼–ç ã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­å°±æ˜¯ä½¿ç”¨äº†UTF-16

const textDecoder = new TextDecoder('utf-16')
const encodedText = Uint16Array.of(102, 111, 111)
const decodedText = textDecoder.decode(encodedText)
console.log(decodedText)
//foo

2.è§£ç æµ

20.4 File API ä¸ Blob API

file API ä¸ Blob API æ˜¯ä¸ºäº†è®©webå¼€å‘è€…èƒ½ä»¥å®‰å…¨çš„æ–¹å¼è®¿é—®å®¢æˆ·ç«¯æœºå™¨ä¸Šçš„æ–‡ä»¶ï¼Œä»è€Œæ›´å¥½åœ°ä¸è¿™äº›æ–‡ä»¶
äº¤äº’è€Œè®¾è®¡çš„ã€‚

20.4.1 Fileç±»å‹

File APIä»ç„¶ä»¥è¡¨å•ä¸­çš„æ–‡ä»¶è¾“å…¥å­—æ®µä¸ºåŸºç¡€ï¼Œä½†æ˜¯å¢åŠ äº†ç›´æ¥è®¿é—®æ–‡ä»¶ä¿¡æ¯çš„èƒ½åŠ›ã€‚HTML5åœ¨domä¸Šä¸ºæ–‡ä»¶
è¾“å…¥å…ƒç´ æ·»åŠ äº†filesé›†åˆã€‚å½“ç”¨æˆ·åœ¨æ–‡ä»¶å­—æ®µä¸­é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶æ—¶ï¼Œè¿™ä¸ªfilesé›†åˆä¼šåŒ…å«ä¸€ç»„Fileå¯¹è±¡ï¼Œ
è¡¨ç¤ºè¢«é€‰ä¸­çš„æ–‡ä»¶ã€‚æ¯ä¸ªFileå¯¹è±¡éƒ½æœ‰ä¸€äº›åªè¯»å±æ€§ã€‚
Â·nameï¼šæœ¬åœ°ç³»ç»Ÿä¸­çš„æ–‡ä»¶å
Â·sizeï¼šä»¥å­—èŠ‚è®¡çš„æ–‡ä»¶å¤§å°
Â·typeï¼šåŒ…å«æ–‡ä»¶MIMEç±»å‹çš„å­—ç¬¦ä¸²
Â·lastModifiedDateï¼šè¡¨ç¤ºæ–‡ä»¶æœ€åä¿®æ”¹æ—¶é—´çš„å­—ç¬¦ä¸²ã€‚è¿™ä¸ªå±æ€§åªæœ‰Chromeå®ç°äº†ã€‚

ä¾‹ï¼š
let filesList = document.getElementById('files-list')
filesList.addEventListener('change', event => {
  let files = event.target.files,
      i = 0,
      len = files.length;

  while(i < len){
    const f = files[i]
    console.log(`${f.name} (${f.type}, ${f.size} bytes)`);
    i++;
  }
})


ä¸è¿‡ï¼Œfile APIè¿˜æä¾›äº†FileReaderç±»å‹ï¼Œè®©æˆ‘ä»¬å¯ä»¥å®é™…ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚

20.4.2 FileReader ç±»å‹

FileReaderç±»å‹è¡¨ç¤ºä¸€ç§å¼‚æ­¥æ–‡ä»¶è¯»å–æœºåˆ¶ã€‚å¯ä»¥æŠŠFileReaderæƒ³è±¡æˆç±»ä¼¼äºXMLHttpRequestï¼Œåªä¸è¿‡
æ˜¯ç”¨äºä»æ–‡ä»¶ç³»ç»Ÿè¯»å–æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä»æœåŠ¡å™¨è¯»å–æ•°æ®ã€‚FileReaderç±»å‹æä¾›äº†å‡ ç§è¯»å–æ–‡ä»¶æ•°æ®çš„æ–¹æ³•ã€‚

Â·readAsText(file, encoding)ï¼šä»æ–‡ä»¶ä¸­è¯»å–çº¯æ–‡æœ¬å†…å®¹å¹¶ä¿å­˜åœ¨resultå±æ€§ä¸­ã€‚
Â·readAsDataURL(file)ï¼šè¯»å–æ–‡ä»¶å¹¶å°†å†…å®¹çš„æ•°æ®URIä¿å­˜åœ¨resultå±æ€§ä¸­ã€‚
Â·readAsBinaryString(file)ï¼šè¯»å–æ–‡ä»¶å¹¶å°†æ¯ä¸ªå­—ç¬¦çš„äºŒè¿›åˆ¶æ•°æ®ä¿å­˜åœ¨resultå±æ€§ä¸­ã€‚
Â·readAsArrayBuffer(file)ï¼šè¯»å–æ–‡ä»¶å¹¶å°†æ–‡ä»¶å†…å®¹ä»¥ArrayBufferå½¢å¼ä¿å­˜åœ¨resultå±æ€§ã€‚

è¿™äº›è¯»å–æ•°æ®çš„æ–¹å¼ä¸ºå¤„ç†æ–‡ä»¶æ•°æ®æä¾›äº†æå¤§çš„çµæ´»æ€§ã€‚å¦‚ï¼Œä¸ºäº†å‘ç”¨æˆ·å±•ç¤ºå›¾ç‰‡ï¼Œå¯ä»¥å°†å›¾ç‰‡è¯»å–ä¸ºæ•°æ®
URIï¼Œè€Œä¸ºäº†è§£ææ–‡ä»¶å†…å®¹ï¼Œå¯ä»¥å°†æ–‡ä»¶è¯»å–ä¸ºæ–‡æœ¬ã€‚

å› ä¸ºè¿™äº›æ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥æ¯ä¸ªFileReaderä¼šå‘å¸ƒå‡ ä¸ªäº‹ä»¶ï¼Œå…¶ä¸­3ä¸ªæœ€æœ‰ç”¨çš„äº‹ä»¶æ˜¯ï¼š
progressã€errorå’Œloadï¼Œåˆ†åˆ«è¡¨ç¤ºè¿˜æœ‰æ›´å¤šæ•°æ®ã€å‘ç”Ÿäº†é”™è¯¯å’Œè¯»å–å®Œæˆã€‚

progressäº‹ä»¶æ¯50æ¯«ç§’å°±ä¼šè§¦å‘ä¸€æ¬¡ï¼Œå…¶ä¸XHRçš„progressäº‹ä»¶å…·æœ‰ç›¸åŒçš„ä¿¡æ¯ï¼šlengthComputableã€
loadedå’Œtotalã€‚æ­¤å¤–ï¼Œåœ¨progressäº‹ä»¶ä¸­å¯ä»¥è¯»å–FileReaderçš„resultå±æ€§ï¼Œå³ä½¿å…¶ä¸­å°šæœªåŒ…å«å…¨éƒ¨æ•°æ®ã€‚

erroräº‹ä»¶ä¼šåœ¨ç”±äºæŸç§åŸå› æ— æ³•è¯»å–æ–‡ä»¶æ—¶è§¦å‘ã€‚è§¦å‘erroräº‹ä»¶æ—¶ï¼ŒFileReaderçš„errorä¼šåŒ…å«é”™è¯¯ä¿¡æ¯ã€‚
è¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåªåŒ…å«ä¸€ä¸ªå±æ€§ï¼šcodeã€‚è¿™ä¸ªé”™è¯¯ç çš„å€¼å¯èƒ½æ˜¯1ï¼ˆæœªæ‰¾åˆ°æ–‡ä»¶ï¼‰ã€2ï¼ˆå®‰å…¨é”™è¯¯ï¼‰ã€
3ï¼ˆè¯»å–è¢«ä¸­æ–­ï¼‰ã€4ï¼ˆæ–‡ä»¶ä¸å¯è¯»ï¼‰æˆ–5ï¼ˆç¼–ç é”™è¯¯ï¼‰ã€‚

loadäº‹ä»¶ä¼šåœ¨æ–‡ä»¶æˆåŠŸåŠ è½½åè§¦å‘ã€‚å¦‚æœerroräº‹ä»¶è¢«è§¦å‘ï¼Œåˆ™ä¸ä¼šåœ¨è§¦å‘loadäº‹ä»¶ã€‚

let filesList = document.getElementById('files-list')
filesList.addEventListener('change', (event) => {
  let info = '',
      output = document.getElementById('output'),
      progress = document.getElementById('progress'),
      files = event.target.files,
      type = 'default',
      reader = new FileReader();

  if(/image/.test(files[0].type)) {
    reader.readAsDataURL(files[0])
    type = 'image';
  } else {
    reader.readAsText(files[0])
    type = 'text'
  }

  reader.onerror = function() {
    output.innerHTML = `Could not read file, error code is ${render.error.code}`
  }

  reader.onprogress = function(event) {
    debugger
    if(event.lengthComputable) {
      progress.innerHTML = `${event.loaded}/${event.total}`
    }
  }

  reader.onload = function() {
    let html = '';

    switch(type) {
      case 'image':
        html = `<img src="${reader.result}"/>`
        break;

      case 'text':
        html = reader.result;
        break;
    }

    output.innerHTML = html;
  }
})


20.4.3 FileReaderSync ç±»å‹

FileReaderSyncç±»å‹å°±æ˜¯FileReaderçš„åŒæ­¥ç‰ˆæœ¬ã€‚è¿™ä¸ªç±»å‹æ‹¥æœ‰ä¸FileReaderç›¸åŒçš„æ–¹æ³•ï¼Œåªæœ‰åœ¨è¿™ä¸ªæ–‡ä»¶
éƒ½åŠ è½½åˆ°å†…å­˜ä¹‹åæ‰ä¼šç»§ç»­æ‰§è¡Œã€‚FileReaderSyncåªæœ‰åœ¨å·¥ä½œçº¿ç¨‹ä¸­å¯ä»¥ç”¨ï¼Œå› ä¸ºå¦‚æœè¯»å–æ•´ä¸ªæ–‡ä»¶è€—æ—¶å¤ªé•¿
åˆ™ä¼šå½±å“å…¨å±€ã€‚

å‡è®¾é€šè¿‡postMessage()å‘å·¥ä½œçº¿ç¨‹å‘é€äº†ä¸€ä¸ªFileå¯¹è±¡ã€‚ä»¥ä¸‹ä»£ç ä¼šè®©å·¥ä½œçº¿ç¨‹åŒæ­¥å°†æ–‡ä»¶è¯»å–åˆ°å†…å­˜ä¸­ï¼Œ
ç„¶åå°†æ–‡ä»¶çš„æ•°æ®URLå‘å›æ¥ã€‚

//worker.js

self.onmessage = messageEvent => {
  const syncReader = new FileReaderSync();
  console.log(syncReader)

  //è¯»å–æ–‡ä»¶æ—¶é˜»å¡å·¥ä½œçº¿ç¨‹
  const result = syncReader.readerAsDataUrl(messageEvent.data)

  //PDFæ–‡ä»¶çš„ç¤ºä¾‹å“åº”
  console.log(result) // data:application/pdf;base64,JVBERi0xLjQK...

  //æŠŠURLå‘å›å»
  self.postMessage(result)
}

20.4.4 Blobä¸éƒ¨åˆ†è¯»å–

æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦è¯»å–éƒ¨åˆ†æ–‡ä»¶è€Œä¸æ˜¯æ•´ä¸ªæ–‡ä»¶ã€‚ä¸ºæ­¤ï¼ŒFileå¯¹è±¡æä¾›äº†ä¸€ä¸ªåä¸ºslice()çš„æ–¹æ³•ã€‚
slice()æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šå…¶å®å­—èŠ‚å’Œè¦è¯»å–çš„å­—èŠ‚æ•°ã€‚è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªBlobçš„ç¤ºä¾‹ï¼Œè€ŒBlobå®é™…ä¸Šæ˜¯
Fileçš„è¶…ç±»ã€‚

blobè¡¨ç¤ºäºŒè¿›åˆ¶å¤§å¯¹è±¡ï¼ˆbinary  larget objectï¼‰ï¼Œæ˜¯jså¯¹ä¸å¯ä¿®æ”¹äºŒè¿›åˆ¶æ•°æ®çš„å°è£…ç±»å‹ã€‚åŒ…å«å­—ç¬¦ä¸²
çš„æ•°ç»„ã€ArrayBuffersã€ArrayBufferViewsï¼Œç”šè‡³å…¶ä»–Blobéƒ½å¯ä»¥ç”¨æ¥åˆ›å»ºblobã€‚Blobæ„é€ å‡½æ•°å¯ä»¥æ¥æ”¶
ä¸€ä¸ªoptionså‚æ•°ï¼Œå¹¶åœ¨å…¶ä¸­æŒ‡å®šMIMEç±»å‹ï¼š

console.log(new Blob(['foo']))
//BlobÂ {size: 3, type: ""}

console.log(new Blob(['{"a": "b"}'], {type: 'application/json'}))
//BlobÂ {size: 10, type: "application/json"}

console.log(new Blob(['<p>Foo</p>','<p>Bar</p>'], {type: 'text/html'}))
//BlobÂ {size: 20, type: "text/html"}

Blobå¯¹è±¡æœ‰ä¸€ä¸ªsizeå±æ€§å’Œtypeå±æ€§ï¼Œè¿˜æœ‰ä¸€ä¸ªslice()æ–¹æ³•ç”¨äºè¿›ä¸€æ­¥åˆ‡åˆ†æ•°æ®ã€‚å¦å¤–ä¹Ÿå¯ä»¥ä½¿ç”¨FileReader
ä»Blobä¸­è¯»å–æ•°æ®ã€‚ä¸‹é¢çš„ä¾‹å­åªä¼šè¯»å–æ–‡ä»¶çš„å‰32å­—èŠ‚ï¼š

let filesList = document.getElementById('files-list')
filesList.addEventListener('change', (event) => {
  let info = '',
      output = document.getElementById('output'),
      progress = document.getElementById('progress'),
      files = event.target.files,
      type = 'default',
      reader = new FileReader(),
      blob = new Blob().slice(files[0], 0, 32);
  if(blob){
    reader.onerror = function() {
      output.innerHTML = `Could not read file, error code is ${render.error.code}`
    }

    reader.onload = function() {
      output.innerHTML = reader.result;
    }

    reader.readAsText(blob);
  } else {
    console.log(`Your browser doesn't support slice().`)
  }
})